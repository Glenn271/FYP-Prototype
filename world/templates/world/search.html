{% extends "world/base.html" %}
{% block content %}
    {% load leaflet_tags %}
    {% load static %}
    {% load i18n %}
    {% load crispy_forms_tags %}
    {% load crispy_forms_filters %}
    <head>
        {% leaflet_js %}
        {% leaflet_css %}
        {% block head_title %}{% trans "Find a Property" %}{% endblock %}
        {% block extra_header %}
            <style>
                #map {width: 70vw;height: 70vh;}
            </style>
        {% endblock %}

    </head>
    <body>
        {% block body_content %}
            <!-- Form for properties -->
        {% if noProp %}
            <p>No properties found, please search again</p>
        {% endif %}

        <form method="POST">
            {% csrf_token %}
            <fieldset class="form-group">
                {#  comes from forms.py #}
                {{ form.city|as_crispy_field }}
                <label>Type of House</label>
                <button class = "btn dropdown-toggle btn-outline-secondary btn-sm"
                        data-toggle = "dropdown">House Types<span class = "caret"></span></button>
                <ul class="dropdown-menu">
                    {{ form.house_type|as_crispy_field }}
                </ul>

                <br>
                {#  rent price slider  #}
                <label>Ideal Rent per month</label>
                <br>
                <input id="rent" name="rent" type="range" min="0" max="10000"
                       value = "5000" step="50"/>
                <label id="rentPrice"></label>
                {#  priority sliders  #}

                <br>
                {#  rent priority slider  #}
                <label>Rent Cost Importance</label>
                <br>
                <label>Low</label>
                <input id="rent_priority" name="rent_priority" type="range" min="0" max="1"
                       value = "0.5" step="0.1"/>
                <label>High</label>

                <br>
                {#  rent priority slider  #}
                <label>House Type Importance</label>
                <br>
                <label>Low</label>
                <input id="house_priority" name="house_priority" type="range" min="0" max="1"
                       value = "0.5" step="0.1"/>
                <label>High</label>

            </fieldset>
            <div class="form-group">
                <button class="btn btn-outline-info" type="submit">Search</button>
            </div>
        </form>

        {% if form.is_valid and not noProp %}
            {% leaflet_map "map" callback="window.map_init_basic" %}
        {% endif %}
        <br>
        <br>

        <div id = "info">
            {% if form.is_valid and not noProp %}
            <h3> Available Properties </h3>
            {% for prop in prop_list %}
                <div class="card" style="width: 70vw;"
                     address = "{{ prop.address }}"
                     rent = "{{ prop.rent }}"
                     lat = "{{ prop.lat }}"
                     lon = "{{ prop.lon }}"
                     rent_sim = "{{ prop.rent_sim }}"
                     beds = "{{ prop.beds }}"
                     baths = "{{ prop.baths }}"
                     house = "{{ prop.house }}"
                     house_sim = "{{ prop.house_sim }}"
                     date_posted = "{{ prop.date_posted }}">

                  <div class="card-body">
                    {% if prop == prop_list.0 %}
                        <i class="fas fa-star" style = "color:darkgoldenrod;"></i>
                        <p class="best-match">Best Match</p>
                        <style>
                            .best-match{
                                color: darkgoldenrod;
                            }
                        </style>
                    {% endif %}
                    <h5 class="card-title">{{ prop.address }}</h5>
                    <p class="card-text">{{ prop.rent }}</p>
                    <p class="card-text">Posted {{ prop.date_posted|date:"F d, Y" }}</p>
                    <a href="{% url 'prop-detail' prop.id  %}" class="btn btn-primary">Property Details &rarr;</a>
                      <ul class = "ul_card">
                            <li class = "rent_rec">Rent</li>
                            <style>
                                .rent_rec{
                                    {% if prop.rent_sim >= 0.7  %}
                                        color:green;
                                    {% elif prop.rent_sim < 0.7 and prop.rent_sim >= 0.4 %}
                                        color:orange;
                                    {% elif prop.rent_sim < 0.4 %}
                                        color:red;
                                    {% else %}
                                        color:grey;
                                    {% endif %}
                                }
                            </style>
                      <li> Beds: {{ prop.beds }}</li>
                      <li> Baths: {{ prop.baths }}</li>
                      <li class = "house_rec"> Property Type: {{ prop.house }}</li>
                      <style>
                                .house_rec{
                                    {% if prop.house_sim == 1 %}
                                        color:green;
                                    {% elif prop.house_sim >= 0.5 and prop.house_sim < 1 %}
                                        color:orange;
                                    {% elif prop.house_sim <= 0.5 %}
                                        color:red;
                                    {% else %}
                                        color:grey;
                                    {% endif %}
                                }
                      </style>
                      </ul>
                  </div>
                </div>
                <br>
            {% endfor %}
        </div>
            {% endif %}
    {% endblock %}
    </body>

    {% block extra_footer %}

        <script>
            var euro = "â‚¬";
            var rent_slider = document.getElementById("rent");
            var rent_label = document.getElementById("rentPrice");
            rent_label.innerHTML = euro.concat(rent_slider.value);

            rent_slider.oninput = function(){
                rent_label.innerHTML = euro.concat(this.value);
            }

            rent_slider.onload = function(){
                rent_label.innerHTML = euro.concat(this.value);
            }
        </script>

        <script>
            $("#body_div").css({"top": $(".site-header").height() + 10, "position": "absolute"});
                $(".toast").css({
                    "top": ($(document).height() / 5),
                    "left": ($(document).width() / 5),
                    "position": "fixed",
                    "z-index": 2000
                });

        </script>

    <script>
        let HOST = location.protocol + "//" + location.host;
        let locationMarker;
        let circle;
        $("#map").css({
            "width": "100%",
            "height": $(document).height() - ($(".site-header").height() + $("#footer").height() + 45)});
        function map_init_basic(map, options) {
            const osm = new L.TileLayer('http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png');
            map.addLayer(osm);
            let pos;
            map.setView([53.5, -8.5], 11);
            updateLocation(map);
            map.on('touchstart click dblclick ', function () {
                updateLocation(map);
            });
        }
        function updateLocation(map) {
            navigator.geolocation.getCurrentPosition(function (pos) {
                setMapToCurrentLocation(map, pos);
                update_db(pos);
                },
                function (err) {
                },
                {
                    enableHighAccuracy: true,
                    timeout: 30000
                }
            );
        }

        //setting the locations of properties on the map
        function setMapToCurrentLocation(map, pos) {
            console.log("In setMapToCurrentLocation.");
            {% if form.is_valid and not noProp %}
                $('.card').each(function() {
                    var address = $(this).attr('address');
                    var rent = $(this).attr('rent');
                    var lat = $(this).attr('lat');
                    var lon = $(this).attr('lon');

                    let myLatLon = L.latLng(lat, lon);
                    locationMarker = new L.Marker(myLatLon).addTo(map);
                    locationMarker.bindPopup("<b>"+address+"</b><br>"+rent);
                });


                let myLatLon = L.latLng('{{ prop_list.0.lat}}', '{{prop_list.0.lon}}');

                map.flyTo(myLatLon, 16);
            {% endif %}
        }

        function update_db(pos) {
            let locString = pos.coords.longitude + ", " + pos.coords.latitude;

            $.ajax({
                type: "POST",
                url :  "{% url 'updatedb' %}",
                headers: {
                    'X-CSRFToken': getCookie('csrftoken')
                },
                data: {
                    point: locString
                }
            }).done(function (data, status, xhr) {
                console.log(data["message"])
                var originalMsg = $(".toast-body").html();
                //$(".toast-body").html(originalMsg + "<br/>Updated database<br/>" + data["message"]);

            }).fail(function (xhr, status, error) {
                console.log('hi' + error);
                var originalMsg = $(".toast-body").html();
                //$(".toast-body").html(originalMsg + "<br/>" + error);
            }).always(function () {
                console.log("find_loc_ed finished");
                //$(".toast").toast('show');
            });
        }

        function getCookie(name) {
            var cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                var cookies = document.cookie.split(';');
                for (var i = 0; i < cookies.length; i++) {
                    var cookie = jQuery.trim(cookies[i]);
                    // Does this cookie string begin with the name we want?
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

    </script>
{% endblock %}
{% endblock content %}


